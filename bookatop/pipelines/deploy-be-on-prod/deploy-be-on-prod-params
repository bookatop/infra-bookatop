/* Introduces steps to build and test the be-bookatop on dev environment */

import com.bookatop.deploy.provider.BackEndProvider

pipeline {
    agent any

    options {
        buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '10', daysToKeepStr: '', numToKeepStr: '10')
    }

    parameters {
        validatingString(
                name: 'serviceNameParam',
                defaultValue: 'auth',
                description: 'Put the service name*',
                failedValidationMessage: 'Service name is empty',
                regex: /^.+$/
        )
    }

    stages {
        stage('Deploy on PROD') {
            steps {
                script {
                    echo "deploy:main:${serviceNameParam}-service.jar on $ENVIRONMENT"

                    GString url = "${env.BACKEND_URL}"
                    GString source = "${env.SOUR_PATH}/${serviceNameParam}-service.jar"
                    GString dest = "${env.DEST_PATH}/${serviceNameParam}-service.jar"
                    GString service = "${serviceNameParam}.prod.service"
                    GString daemon = "${serviceNameParam}.prod.service"

                    logger = { echo it }
                    error = { error it }

                    new BackEndProvider(
                            url,
                            source,
                            dest,
                            service,
                            daemon
                    ).deploy(logger, error)
                }
            }
        }
    }
}