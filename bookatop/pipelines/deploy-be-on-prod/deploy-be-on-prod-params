/* Introduces steps to build and test the be-bookatop on dev environment */

pipeline {
    agent any

    parameters {
        validatingString(
                name: 'serviceNameParam',
                defaultValue: 'auth',
                description: 'Put the service name*',
                failedValidationMessage: 'Service name is empty',
                regex: /^.+$/
        )
    }

    stages {
        stage('Deploy on PROD') {
            steps {
                script {

                    GString servicePlace = "main:${serviceNameParam}-service on $ENVIRONMENT"

                    echo "Deploy $servicePlace"

                    GString backendUrl = "${env.BACKEND_URL}"
                    GString sourceFile = "${env.SOUR_PATH}/${serviceNameParam}-service.jar"
                    GString destFile = "${env.DEST_PATH}/${serviceNameParam}-service.jar"
                    GString serviceName = "${serviceNameParam}.prod.service"
                    GString daemonName = "${serviceNameParam}.prod.service"

                    DeployBuild deployBuild = new DeployBuild(
                            backendUrl,
                            sourceFile,
                            destFile,
                            serviceName,
                            daemonName
                    )

                    deployBuild.deploy({
                        echo it
                    }, {
                        error it
                    })

                    echo "The $servicePlace is success deployed"
                }
            }
        }
    }
}