/* Introduces steps to build and test the be-bookatop on dev environment */

import com.bookatop.utils.FileUtils

pipeline {
    agent any

    options {
        buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '10', daysToKeepStr: '', numToKeepStr: '10')
    }

    stages {
        stage('Build on DEV') {
            steps {
                sh 'gradle clean build test'
            }
        }
        stage('Copy on DEV') {
            steps {
                script {
                    /* List of services */
                    services = [
                        'auth'
                    ]
                    logger = { echo it }
                    errorLog = { error it }

                    FileUtils utils = new FileUtils(logger, errorLog)

                    services.each { item ->
                        echo "build:${BRANCH_NAME}:$item:${BUILD_NUMBER} on $ENVIRONMENT"

                        source = "${WORKSPACE}/${SOUR_PATH}/${item}/build/libs/${item}-service.jar"
                        destDir = "${DEST_PATH}/${BRANCH_NAME}"
                        dest = "${destDir}/${item}-service-${BUILD_NUMBER}.jar"

                        utils.makeDir(destDir)
                        utils.copyFile(source, dest)
                        utils.fileExists(dest)
                    }
                }
            }
        }
    }
}